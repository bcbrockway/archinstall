#!/bin/bash

####################################################
##   RUN THE FOLLOWING LOCALLY ON THE LAPTOP/PC   ##
####################################################

## Check to ensure you have booted in EFI mode
ls /sys/firmware/efi

## Connect to WiFi
ip link set wlp58s0 up
wpa_supplicant -B -i wlp58s0 -c <(wpa_passphrase XXXXX XXXXX)
dhcpcd wlp58s0

## Enable SSH
pacman -S openssh
systemctl start sshd
passwd

## Get larger screen font
pacman -Sy terminus-font
setfont ter-v32n

## Create dir for install
mkdir /archinstall

###############################################################
##   RUN THE FOLLOWING IN THE DIR WHERE THIS SCRIPT RESIDES  ##
###############################################################

scp -r * root@XXX.XXX.XXX.XXX:/archinstall/

############################
##  NOW CONNECT OVER SSH  ##
############################

cp mirrorlist /etc/pacman.d/mirrorlist
cat /proc/partitions
gdisk /dev/nvme0n1
mount /dev/nvme0n1p5 /mnt  # <-- New Linux partition created with gdisk
mkdir /mnt/boot
mount /dev/nvme0n1p2 /mnt/boot  # <-- EFI partition created by Windows
pacstrap /mnt
arch-chroot /mnt
pacman -Sy vim wpa_supplicant openssh terminus-font sudo
wpa_passphrase XXXXX XXXXX > /etc/wpa_supplicant/wpa_supplicant-wlp58s0.conf
systemctl enable wpa_supplicant@wlp58s0.service
systemctl enable dhcpcd@wlp58s0
systemctl enable sshd
bootctl install
cd /boot/loader
vim loader.conf
cd /boot/loader/entries
vim arch.conf
exit
reboot

## Set up keyboard for console
echo "KEYMAP=uk" > /etc/vconsole.conf

## Set font for console (HiDPI)
echo "FONT=ter-v32n" >> /etc/vconsole.conf

## Set up new user
NEWUSER=XXXXX
useradd -G wheel -m ${NEWUSER}
sed --in-place 's/^#\s*\(%wheel\s\+ALL=(ALL)\s\+NOPASSWD:\s\+ALL\)/\1/' /etc/sudoers

## Install Xorg
pacman -S xorg-server mesa xf86-video-intel intel-media-driver xf86-input-libinput xorg-xinput xorg-xdpyinfo xorg-xrdb

## Install GDM
pacman -S gdm
systemctl enable gdm.service

## Install i3
pacman -S i3-wm i3lock i3status dmenu terminator

## Configure HiDPI display
cat <<EOF >/home/${NEWUSER}/.Xresources
Xft.dpi: 180
Xft.autohint: 0
Xft.lcdfilter:  lcddefault
Xft.hintstyle:  hintfull
Xft.hinting: 1
Xft.antialias: 1
Xft.rgba: rgb
EOF

## Install git
pacman -S git
